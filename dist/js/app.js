$(function(){function e(e,t,a,s){var o=s||5,i="https://api.foursquare.com/v2/venues/search?client_id=HPTKFD3QU12Y0FPPQ0OVTZ51RFAYJ5L4104MNJJL0CW2HEEQ&client_secret=YLBK5PYZW4FZNK0QIQX5SCJOQS4TYYEHR2LZ2SHYGJLXJCLE&v=20130815&ll="+e+","+t+"&intent=checkin&radius=500&limit="+o;return i+="&categoryId=4bf58dd8d48988d184941735,4bf58dd8d48988d1b4941735",i+="&query="+encodeURIComponent(a)}function t(e,t){var a=t||5,s="https://api.foursquare.com/v2/venues/"+e+"/photos?client_id=HPTKFD3QU12Y0FPPQ0OVTZ51RFAYJ5L4104MNJJL0CW2HEEQ&client_secret=YLBK5PYZW4FZNK0QIQX5SCJOQS4TYYEHR2LZ2SHYGJLXJCLE&v=20130815";return s+="&limit="+a}function a(e){var t="http://api.nytimes.com/svc/search/v2/articlesearch.json?&api-key=5970e8422dc755c43539b1a554bd3017:18:34329006",a='news_desk:("Sports") AND body:("'+e+'")';return t+="&fq="+encodeURIComponent(a)}function s(e){return e.replace(/&#(\d+);/g,function(e,t){return String.fromCharCode(t)})}var o=function(e){this.name=ko.observable(e.name),this.lat=ko.observable(e.lat),this.lng=ko.observable(e.lng),this.visible=ko.observable("boolean"==typeof e.visible?e.visible:!0),this.teams=ko.observableArray([]);for(var t=0;t<e.teams.length;t++)this.teams.push({name:ko.observable(e.teams[t].name),league:ko.observable(e.teams[t].league)});this.foursquareid=ko.observable(null),this.foursquareid.extend({rateLimit:50}),this.address=ko.observableArray([]),this.address.extend({rateLimit:50}),this.photos=ko.observableArray([]),this.photos.extend({rateLimit:50}),this.articles=ko.observableArray([]),this.articles.extend({rateLimit:50}),this.mapPoint=ko.computed(function(){return{lat:this.lat(),lng:this.lng()}},this),this.icon=ko.computed(function(){var e,t="multi";return this.teams()&&1==this.teams().length&&(t=this.teams()[0].league().toLowerCase()),e="img/"+t+"-marker.png",{anchor:new google.maps.Point(12,12),url:e}},this),this.marker=ko.observable(new google.maps.Marker({position:this.mapPoint(),title:this.name(),icon:this.icon()})),this.searchString=ko.computed(function(){for(var e=this.name(),t=0;t<this.teams().length;t++)e+=" "+this.teams()[t].name();return e.toUpperCase()},this),this.inLeagues=ko.computed(function(){for(var e=[],t=0;t<this.teams().length;t++)e.push(this.teams()[t].league());return e},this)},i=function(e){this.league=ko.observable(e.league),this.display=ko.observable(e.display),this.imageSrc=ko.computed(function(){var e,t="img/";return e=this.display()?this.league().toLowerCase()+".png":this.league().toLowerCase()+"-off.png",t+e},this)},n={gettingNYTimesData:!1,gettingFoursquareData:!1,gettingFoursquarePhotos:!1,isGettingData:function(){return this.gettingNYTimesData||this.gettingFoursquareData||this.gettingFoursquarePhotos},getRemoteData:function(e,t){console.log("Get remote data"),t.gettingdata(this.isGettingData()),t.errors([]),null===e.foursquareid()&&this.getFoursquareData(e,t),0===e.articles().length&&this.getNYTimesData(e,t)},getFoursquareData:function(t,a){var s=this;s.gettingFoursquareData||(s.gettingFoursquareData=!0,a.gettingdata(s.isGettingData()),$.ajax({dataType:"json",url:e(t.lat(),t.lng(),t.name()),success:function(e){console.log("Got 4sq data");var o,i;if(i=e.response.venues[0],0===t.address.length)for(o in i.location.formattedAddress)t.address.push(i.location.formattedAddress[o]);t.foursquareid(i.id),s.gettingFoursquareData=!1,a.gettingdata(s.isGettingData()),0===t.photos().length&&s.getFoursquarePhotos(t,a)},error:function(){console.log("Error getting foursquare data"),s.gettingFoursquareData=!1,a.errors.push("Error getting Foursquare data"),a.gettingdata(s.isGettingData())}}))},getFoursquarePhotos:function(e,a){var s=this;s.gettingFoursquarePhotos||(console.log("getting photos"),s.gettingFoursquarePhotos=!0,a.gettingdata(s.isGettingData()),$.ajax({dataType:"json",url:t(e.foursquareid()),success:function(t){console.log("got photos");var o=t.response.photos.items;if(0===e.photos.length)for(var i in o){var n=o[i].prefix+"cap300"+o[i].suffix;e.photos.push(n)}s.gettingFoursquarePhotos=!1,a.gettingdata(s.isGettingData())},error:function(){console.log("Error getting photos"),s.gettingFoursquarePhotos=!1,a.errors.push("Error getting Foursquare photos"),a.gettingdata(s.isGettingData())}}))},getNYTimesData:function(e,t){var o=this;o.gettingNYTimesData||(o.gettingNYTimesData=!0,t.gettingdata(o.isGettingData()),$.ajax({dataType:"json",url:a(e.name()),success:function(a){var i;if("OK"===a.status&&0===e.articles.length){i=a.response.docs;for(var n in i)e.articles.push({url:i[n].web_url,headline:s(i[n].headline.main)});console.log("Got NY Times articles")}else console.log("Error getting NY Times articles"),t.errors.push("Error getting NY Times articles");o.gettingNYTimesData=!1,t.gettingdata(o.isGettingData())},error:function(){console.log("Error getting NY Times articles"),o.gettingNYTimesData=!1,t.errors.push("Error getting NY Times articles"),t.gettingdata(o.isGettingData())}}))},reset:function(){this.gettingNYTimesData=!1,this.gettingFoursquareData=!1,this.gettingFoursquarePhotos=!1}},r=function(){var e,t,a,s=this,r=[];s.map=null,s.infowindow=null,s.datastatus=ko.observable({gettingdata:ko.observable(!0),errors:ko.observableArray([])}),s.searchtext=ko.observable(""),s.searchtext.extend({rateLimit:{timeout:400,method:"notifyWhenChangesStop"}}),s.filters=ko.observableArray([]),s.emptysearch=ko.observable(!1),s.stadiums=ko.observableArray([]),s.stadiums.extend({rateLimit:{timeout:20,method:"notifyWhenChangesStop"}}),t=stadiumData.sort(function(e,t){var a=e.name.toUpperCase(),s=t.name.toUpperCase();return s>a?-1:a>s?1:0});for(var g in t)for(s.stadiums.push(new o(stadiumData[g])),a=0;a<stadiumData[g].teams.length;a++){var d=stadiumData[g].teams[a];r.indexOf(d.league)<0&&r.push(d.league)}for(s.selectedStadium=ko.observable(null),s.selectedStadium.extend({rateLimit:{timeout:10,method:"notifyWhenChangesStop"}}),s.showMarker=function(e){s.toggleMenuOpen(),n.reset(),e.marker().setAnimation(google.maps.Animation.BOUNCE),window.setTimeout(function(){e.marker().setAnimation(null)},2e3),s.selectedStadium(e),n.getRemoteData(e,s.datastatus())},s.toggleMenuOpen=function(){console.log("toggle"),$("#stad-list-hideable").toggleClass("stad-menu-offsmall"),$("#stad-list-menu-toggle .fa").toggleClass("fa-caret-down"),$("#stad-list-menu-toggle .fa").toggleClass("fa-caret-up")},s.toggleFilter=function(e){e.display(!e.display())},s.filterList=function(){var e,t,a,o=s.searchtext().toUpperCase().trim(),i=o.split(/\s+/),n=[],r=!0;for(var g in s.filters())s.filters()[g].display()&&n.push(s.filters()[g].league());for(null===s.selectedStadium()||l(s.selectedStadium(),i,n)||(s.selectedStadium(null),console.log("Setting stadium to null")),a=0;a<s.stadiums().length;a++)e=s.stadiums()[a],t=l(e,i,n),e.visible(t),r&&t&&(r=!1);s.stadiums.valueHasMutated(),s.emptysearch(r),u(".stad-list-ul","stad-list-last")},s.searchtext.subscribe(s.filterList),a=0;a<r.length;a++)e=new i({league:r[a],display:!0}),e.display.subscribe(s.filterList),s.filters.push(e)},l=function(e,t,a){if(visible=!1,g(e,a))for(j=0;j<t.length;j++)if(e.searchString().indexOf(t[j])>=0){visible=!0;break}return visible},g=function(e,t){var a=!1,s=e.inLeagues();for(var o in s)if(t.indexOf(s[o])>=0){a=!0;break}return a},u=function(e,t){$("."+t).removeClass(t),$(e).children().filter(":visible:last").addClass(t)};ko.bindingHandlers.googlemap={init:function(e,t,a,s,o){var i={zoom:4,center:{lat:39.8282,lng:-98.5795},disableDefaultUI:!0,scrollwheel:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.RIGHT_BOTTOM}},n=o.$data;n.map=new google.maps.Map(e,i),google.maps.event.addListenerOnce(n.map,"tilesloaded",function(){console.log("adding event listener");var e=document.createElement("div");e.id="stadium-list-control";var t=$("#stadium-list").detach();n.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(e),t.appendTo("#stadium-list-control"),$("#stad-list-menu-toggle").click(function(){n.toggleMenuOpen()})})},update:function(e,t,a,s,o){function i(e,t,a){google.maps.event.clearListeners(e,"click"),google.maps.event.addListener(e,"click",function(){a.showMarker(t)})}var n=t,r=o.$data;console.log("Calling update on map");for(var l in n().stadiums()){var g=n().stadiums()[l];g.visible.peek()?(g.marker().setMap(r.map),i(g.marker(),g,r)):(g.marker().setMap(null),console.log("Removing from map"))}}},ko.bindingHandlers.infowindow={init:function(e,t,a,s,o){var i=o.$data;i.infowindow=new google.maps.InfoWindow({content:'<div id="info-window"></div>'})},update:function(e,t,a,s,o){function i(e){google.maps.event.addListener(e,"domready",function(){var e=$("#selected-stadium-info").html();$("#info-window").html(e)})}console.log("Update info window");{var n=o.$data,r=n.infowindow,l=t().stadium();t().messages()}if(r.close(),null!==l){r.open(n.map,l.marker()),i(r);{t().messages().gettingdata(),t().messages().errors(),t().stadium().photos(),t().stadium().address(),t().stadium().articles()}}else console.log("Stadium is null")}},"undefined"!=typeof google?ko.applyBindings(new r):(console.log("Error loading Google Maps API"),$(".map-canvas").hide(),$("body").prepend('<div class="error-dialog"><p class="error-message">There was an error loading Google Maps. Please check your internet connection or try again later.</p></div>'))});